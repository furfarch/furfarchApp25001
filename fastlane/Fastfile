default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight using repo exportOptions plist"
  lane :ci_beta do
    # Ensure required envs are present
    key_id = ENV['APP_STORE_CONNECT_KEY_ID']
    issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
    key_path = ENV['FASTLANE_APPLE_API_KEY_PATH'] || "fastlane/credentials/AuthKey_#{key_id}.p8"

    UI.user_error!("Missing APP_STORE_CONNECT_KEY_ID or APP_STORE_CONNECT_ISSUER_ID") unless key_id && issuer_id

    # Build the app using the repo exportOptions plist
    export_plist = "ci/exportOptions.app-store.plist"
    sh("/usr/bin/xcrun xcodebuild -project #{ENV['PROJECT_PATH'] || 'furfarchApp25001.xcodeproj'} -scheme #{ENV['SCHEME'] || 'furfarchApp25001'} -configuration Release -destination generic/platform=iOS -archivePath /tmp/#{ENV['SCHEME'] || 'furfarchApp25001'}.xcarchive clean archive -allowProvisioningUpdates")

    # Export using xcodebuild and the repo plist (this avoids Fastlane gym plist quirks)
    ipa_output_dir = Dir.mktmpdir
    ipa_path = File.join(ipa_output_dir, "#{ENV['SCHEME'] || 'furfarchApp25001'}.ipa")

    sh("xcodebuild -exportArchive -archivePath /tmp/#{ENV['SCHEME'] || 'furfarchApp25001'}.xcarchive -exportPath #{ipa_output_dir} -exportOptionsPlist #{export_plist} -allowProvisioningUpdates -verbose")

    ipa = Dir[File.join(ipa_output_dir, "*.ipa")].first
    UI.user_error!("IPA not found after export") unless ipa

    # Upload to TestFlight using API key
    upload_to_testflight(
      ipa: ipa,
      api_key: {
        key_id: key_id,
        issuer_id: issuer_id,
        key_filepath: key_path
      },
      skip_waiting_for_build_processing: false
    )
  end
end
